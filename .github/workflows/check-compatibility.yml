name: Check main on JD+ develop

on:
  workflow_dispatch:
  push:
    branches:
      - main

env:
  MAVEN_ARGS: "-B -ntp"

jobs:
  check-main-job:
    strategy:
      fail-fast: false
      matrix:
        plugin:
          - 'jdemetra/jdplus-benchmarking'
          - 'jdemetra/jdplus-incubator'
          - 'jdemetra/jdplus-experimental'
          - 'jdemetra/jdplus-revisions'
          - 'jdemetra/jdplus-nowcasting'
          - 'nbbrd/jdplus-sdmx'

    name: ${{matrix.plugin}}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout and Setup Maven
        uses: s4u/setup-maven-action@v1.18.0
        with:
          checkout-submodules: true
          checkout-fetch-depth: 0
          java-version: 17

      - name: Create artifact name
        run: |
          echo "artifact_name=$(echo ${{matrix.plugin}} | tr "/" "_")" >> $GITHUB_ENV

      - name: Setup and run compilation to create report
        run: mvn com.github.nbbrd.nbbrd-maven-tools:compatibility-maven-plugin::check-downstream -Dcompatibility.source=https://github.com/jdemetra/jdplus-main -Dcompatibility.targets=${{matrix.plugin}} -Dcompatibility.property=jdplus-main.version -Dcompatibility.target.limit=2 -Dcompatibility.report.file=${{env.artifact_name}}.md

      - name: Print report
        run: cat ${{env.artifact_name}}.md

      - name: Upload report
        uses: actions/upload-artifact@v4
        with:
          name: ${{env.artifact_name}}
          path: ${{env.artifact_name}}.md
